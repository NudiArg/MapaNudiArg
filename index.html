<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> </title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        #map { height: 600px; width: 100%; }
        .popup-img { width: 200px; height: auto; max-width: 100%; }  /* Ajusta el tamaño de la imagen */
        .popup-species {
            font-style: italic;
        }
    </style>
</head>
<body>
    <h2> </h2>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        // Crear el mapa
        var map = L.map('map').setView([-38.4161, -63.6167], 5); // Centrado en Argentina

        // Añadir capa base de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Crear una capa de agrupación de marcadores
        var markers = L.markerClusterGroup();

        // URL del archivo CSV en tu repositorio de GitHub
        var csvUrl = "https://raw.githubusercontent.com/NudiArg/MapaNudiArg/main/registros_nudibranquios.csv"; // Asegúrate de poner la URL correcta

        // Función para cargar el CSV y agregar los marcadores
        function loadCSV(url) {
            fetch(url)
                .then(response => response.text())
                .then(data => {
                    var rows = data.split('\n'); // Dividir por líneas
                    rows.forEach((row, index) => {
                        if (index === 0 || row.trim() === "") return; // Omitir cabecera y filas vacías
                        var cols = row.split(','); // Dividir columnas por comas

                        // Leer las columnas del CSV
                        var observador = cols[0];
                        var fecha = new Date(cols[1]); // Convertir la fecha a un objeto Date
                        var especie = cols[2];
                        var lat = parseFloat(cols[3]);
                        var lng = parseFloat(cols[4]);
                        var foto = cols[5];

                        if (!isNaN(lat) && !isNaN(lng)) {
                            // Formatear la fecha en formato solo fecha
                            var fechaFormateada = fecha.toLocaleDateString("es-AR");

                            // Verificar que la URL de la imagen sea válida antes de agregarla
                            var image = new Image();
                            image.onload = function() {
                                // Crear el contenido del popup solo si la imagen carga correctamente
                                var popupContent = `
                                    <strong>Especie:</strong> <span class="popup-species">${especie}</span><br>
                                    <strong>Observador:</strong> ${observador}<br>
                                    <strong>Fecha:</strong> ${fechaFormateada}<br>
                                    <img src="${foto}" alt="Foto del nudibranquio" class="popup-img">
                                `;

                                // Crear el marcador con la imagen cargada
                                var marker = L.marker([lat, lng]).bindPopup(popupContent);
                                markers.addLayer(marker);
                            };
                            image.onerror = function() {
                                // Si la imagen no carga, podemos agregar un texto alternativo o una imagen predeterminada
                                var popupContent = `
                                    <strong>Especie:</strong> <span class="popup-species">${especie}</span><br>
                                    <strong>Observador:</strong> ${observador}<br>
                                    <strong>Fecha:</strong> ${fechaFormateada}<br>
                                    <img src="https://via.placeholder.com/200" alt="Imagen no disponible" class="popup-img">
                                `;
                                var marker = L.marker([lat, lng]).bindPopup(popupContent);
                                markers.addLayer(marker);
                            };
                            image.src = foto; // Intentamos cargar la imagen desde la URL

                        }
                    });

                    // Añadir los marcadores agrupados al mapa
                    map.addLayer(markers);
                })
                .catch(error => console.error('Error cargando el CSV:', error));
        }

        // Cargar los datos al iniciar
        loadCSV(csvUrl);
    </script>
</body>
</html>
